<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<title>How to Deploy an OpenVPN Server on OpenWrt 19.07 - LaRoccx</title>
<meta name=description content="📌 This should also work on the current OpenWrt 21.02 release candidate.
This guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.">
<meta name=author content="Robert LaRocca">
<link href=https://www.laroccx.com/an-old-hope.min.css rel=stylesheet>
<link href=https://www.laroccx.com/style.css rel=stylesheet>
<link href=https://www.laroccx.com/custom.css rel=stylesheet>
<link rel=apple-touch-icon href=https://www.laroccx.com/apple-touch-icon.png>
<link rel=icon href=https://www.laroccx.com/favicon.ico>
<meta name=generator content="Hugo 0.86.0">
<meta property="og:title" content="How to Deploy an OpenVPN Server on OpenWrt 19.07">
<meta property="og:description" content="📌 This should also work on the current OpenWrt 21.02 release candidate.
This guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.laroccx.com/posts/openvpn-openwrt/"><meta property="og:image" content="https://www.laroccx.com/robert_larocca.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-06-20T03:15:00-04:00">
<meta property="article:modified_time" content="2021-06-20T03:15:00-04:00"><meta property="og:site_name" content="LaRoccx">
<script>function setTheme(){if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');return}const c=new Date,g=localStorage.getItem('date'),d=String(c.getMonth()+1)+'.'+String(c.getDate()),e=c.getTime();let a,b;function f(){if(e>a&&e<b)return;document.body.classList.add('dark')}d!==g?(fetch('https://api.ipgeolocation.io/astronomy?apiKey=5ed37d85103e4defa5df4c5298ed5215').then(a=>a.json()).then(c=>{a=c.sunrise.split(':').map(Number),b=c.sunset.split(':').map(Number)}).catch(()=>{a=[7,0],b=[19,0]}).finally(()=>{a=c.setHours(a[0],a[1],0),b=c.setHours(b[0],b[1],0),f(),localStorage.setItem('sunrise',a),localStorage.setItem('sunset',b)}),localStorage.setItem('date',d)):(a=Number(localStorage.getItem('sunrise')),b=Number(localStorage.getItem('sunset')),f())}</script>
</head>
<body class=single>
<script>setTheme()</script>
<header class=header>
<nav class=nav>
<p class=logo><a href=https://www.laroccx.com/>LaRoccx</a></p>
<ul class=menu>
<li>
<a href=/posts/>Posts</a>
</li>
<li>
<a href=/categories/>Categories</a>
</li>
<li>
<a href=/tags/>Tags</a>
</li>
<li>
<a href=/archives/>Archive</a>
</li>
<li>
<a href=/search/>Search</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>How to Deploy an OpenVPN Server on OpenWrt 19.07</h1>
<div class=post-meta>Robert LaRocca · June 20, 2021</div>
</header>
<div class=post-content><p>📌 This should also work on the current <code>OpenWrt 21.02</code> release candidate.</p>
<p>This guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.</p>
<ul>
<li>Access shared files, printers and other services.</li>
<li>Protect screen sharing and remote desktop connections.</li>
<li>Prevent eavesdropping while using public Wi-Fi networks</li>
<li>Watch Xfinity Stream (in-home) only channels from anywhere.</li>
<li>Expand this list ad nauseam.</li>
</ul>
<h2 id=what-is-openvpn>What is OpenVPN?</h2>
<blockquote>
<p>OpenVPN is a full-featured open source SSL/TLS virtual private network that accommodates a wide range of configurations, including remote access, site-to-site VPNs, Wi-Fi security, and [enterprise-scale solutions] with load balancing, failover, and fine-grained access-controls. Starting with the fundamental premise that complexity is the enemy of security. OpenVPN offers a cost-effective, lightweight alternative to other VPN technologies that is well-adapted for the [home, small business, educational] and enterprise markets.</p>
</blockquote>
<h2 id=packages>Packages</h2>
<p>Before getting started it&rsquo;s a good idea to update the installed software on your OpenWrt device. Package updates generally resolve known issues, provide enhancements, and patch security vulnerabilities.</p>
<h3 id=upgrade-all-installed-packages>Upgrade all installed packages</h3>
<p>These commands will not upgrade the OpenWrt operating system or Linux kernel. Only packages installed using <code>luci</code> or <code>opkg</code> are upgraded.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>opkg update
opkg install <span style=color:#66d9ef>$(</span>opkg list-upgradable | awk <span style=color:#e6db74>&#39;{ printf &#34;%s &#34;,$1 }&#39;</span><span style=color:#66d9ef>)</span>
</code></pre></div><h3 id=install-openvpn-and-easyrsa>Install OpenVPN and EasyRSA</h3>
<p>Install <em>only</em> the OpenVPN package build using OpenSSL. This version requires more storage then other OpenVPN packages, but offers better performance and supports more encryption algorithms.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>opkg install openvpn-openssl openvpn-easy-rsa
</code></pre></div><h2 id=certificate-authority>Certificate Authority</h2>
<p>OpenVPN requires it&rsquo;s own Public Key Infrastructure (PKI) which consists of a Certificate Authority (CA) to sign server and client certificates. The certificates and private keys created during the next few steps are saved to <code>/etc/easy-rsa/pki</code>. See <a href=https://openvpn.net/community-resources/setting-up-your-own-certificate-authority-ca/>setting up your own Certificate Authority (CA)</a> for more information.</p>
<h3 id=create-a-certificate-authority>Create a certificate authority</h3>
<p>Generate a OpenVPN certificate authority using the following commands.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>easyrsa init-pki
easyrsa build-ca
</code></pre></div><h3 id=create-a-diffie-hellman>Create a Diffie Hellman</h3>
<p>Generate the Diffie Hellman parameter using <code>easyrsa build-dh dh.pem</code>. This could take a long time, depending on your OpenWrt device CPU and available entropy.</p>
<h3 id=create-a-tls-auth-key>Create a TLS auth key</h3>
<blockquote>
<p>The tls-auth directive adds an additional HMAC signature to all TLS handshake packets for integrity verification and provides an additional level of security above and beyond that provided by TLS alone.</p>
</blockquote>
<p>Using the additional tls-auth server options can help protect against:</p>
<ul>
<li>DoS attacks or port flooding on the OpenVPN UDP port.</li>
<li>Port scanning to determine which server UDP ports are in a listening state.</li>
<li>Buffer overflow vulnerabilities in the TLS implementation.</li>
<li>TLS handshake initiations from unauthorized machines are cutoff much earlier.</li>
</ul>
<p>Generate a tls-auth key using <code>openvpn --genkey --secret ta.key</code>.</p>
<p>📢 This key should be copied to both the server and client devices.</p>
<h3 id=create-a-server-certificate>Create a server certificate</h3>
<p>Generate a server certificate using the following <code>easyrsa</code> command. Substitute the hostname <code>openvpn.example.com</code> with your fully qualified domain name (FQDN).</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>easyrsa --subject-alt-name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;DNS:openvpn.example.com&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	build-server-full <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	openvpn.example.com <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	nopass
</code></pre></div><h3 id=create-client-certificates>Create client certificates</h3>
<p>Generate a client certificate using <code>easyrsa build-client-full user1 nopass</code>. Substitute <code>user1</code> with your real username.</p>
<p>📢 This step should be repeated for every user in your environment.</p>
<p>🚫 Never share a single client certificate amongst multiple users. Redistributing new client certificates to every user, because access was revoked from a single bad actor is a security nightmare and allot of unnecessary work.</p>
<p>Now that your certificate authority, server certificate, server private key, diffie-hellman, and certificate revocation list is generated, copy them to <code>/etc/openvpn/</code>.</p>
<h2 id=configure>Configure</h2>
<h3 id=configure-openvpn-server>Configure OpenVPN server</h3>
<p>Edit the OpenVPN server configuration file <code>/etc/openvpn/server.conf</code>. You should modify these settings to match your specific environment.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># The OpenVPN configuration file</span>

port <span style=color:#ae81ff>1194</span>
proto udp
dev tun

ca ca.crt
cert openvpn.example.com.crt
key openvpn.example.com.key
crl-verify crl.pem
dh dh.pem

topology subnet
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist /var/openvpn/persist.leases
status /var/openvpn/status.log

push <span style=color:#e6db74>&#34;route 192.168.1.0 255.255.255.0&#34;</span>
push <span style=color:#e6db74>&#34;route 10.8.0.0 255.255.255.0&#34;</span>
push <span style=color:#e6db74>&#34;redirect-gateway def1 bypass-dhcp&#34;</span>
push <span style=color:#e6db74>&#34;dhcp-option DNS 192.168.1.1&#34;</span>
push <span style=color:#e6db74>&#34;dhcp-option DOMAIN lan&#34;</span>

client-to-client
max-clients <span style=color:#ae81ff>254</span>

keepalive <span style=color:#ae81ff>10</span> <span style=color:#ae81ff>120</span>
persist-key
persist-tun

cipher AES-256-GCM
auth SHA384

tls-auth ta.key <span style=color:#ae81ff>0</span>
tls-version-min 1.2
tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384

compress lz4-v2
push <span style=color:#e6db74>&#34;compress lz4-v2&#34;</span>

user nobody
group nogroup

verb <span style=color:#ae81ff>3</span>  <span style=color:#75715e># verbosity levels range from 0-low 3-default 9-devel</span>
mute <span style=color:#ae81ff>10</span> <span style=color:#75715e># quite repeating logs after 20 messages</span>

<span style=color:#75715e># Only used this option in UDP mode.</span>
explicit-exit-notify <span style=color:#ae81ff>1</span>
</code></pre></div><p>👀 The OpenVPN Community <a href=https://openvpn.net/community-resources/reference-manual-for-openvpn-2-4/>reference manual</a> explains every setting in detail.</p>
<h3 id=create-a-network-interface>Create a network interface</h3>
<p>Add the following settings to <code>/etc/config/network</code>. This will create a OpenWrt network interface used to configure the firewall.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>config interface <span style=color:#e6db74>&#39;vpn&#39;</span>
	option ifname <span style=color:#e6db74>&#39;tun0&#39;</span>
	option proto <span style=color:#e6db74>&#39;none&#39;</span>
	option delegate <span style=color:#e6db74>&#39;0&#39;</span>
</code></pre></div><h3 id=create-a-firewall-zone>Create a firewall zone</h3>
<p>Add the following settings to <code>/etc/config/firewall</code>. This will create a OpenWrt firewall zone.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>config zone
	option name <span style=color:#e6db74>&#39;vpn&#39;</span>
	option input <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
	option output <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
	option forward <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
	option masq <span style=color:#e6db74>&#39;1&#39;</span>
	option mtu_fix <span style=color:#e6db74>&#39;1&#39;</span>
	list network <span style=color:#e6db74>&#39;vpn&#39;</span>
</code></pre></div><h3 id=configure-firewall-zone-forwarding>Configure firewall zone forwarding</h3>
<p>Add the following settings to <code>/etc/config/firewall</code> to configure firewall zone forwarding. This allows OpenVPN traffic to access both <code>lan</code> and <code>wan</code> zones.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>config forwarding
	option src <span style=color:#e6db74>&#39;lan&#39;</span>
	option dest <span style=color:#e6db74>&#39;vpn&#39;</span>

config forwarding
	option src <span style=color:#e6db74>&#39;vpn&#39;</span>
	option dest <span style=color:#e6db74>&#39;lan&#39;</span>

config forwarding
	option src <span style=color:#e6db74>&#39;vpn&#39;</span>
	option dest <span style=color:#e6db74>&#39;wan&#39;</span>
</code></pre></div><h3 id=create-an-openvpn-firewall-rule>Create an OpenVPN firewall rule</h3>
<p>Add the following settings to <code>/etc/config/firewall</code> to configure a firewall rule to allow inbound traffic from the Internet. Client devices will be unable to communicate with the OpenVPN server without this firewall rule enabled.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>config rule
	option name <span style=color:#e6db74>&#39;Allow-OpenVPN-Server&#39;</span>
	option src <span style=color:#e6db74>&#39;wan&#39;</span>
	option dest_port <span style=color:#e6db74>&#39;1194&#39;</span>
	option proto <span style=color:#e6db74>&#39;udp&#39;</span>
	option target <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
</code></pre></div><h3 id=configure-system-startup-script>Configure system startup script</h3>
<p>This was once required and may no longer be required. If, OpenWrt refuses to start automatically after a reboot. Add the following to <code>/etc/rc.local</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -x <span style=color:#e6db74>&#34;/usr/sbin/openvpn&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
	<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -d <span style=color:#e6db74>&#34;/tmp/openvpn&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
		mkdir -p /tmp/openvpn &gt;&amp; /dev/null
	<span style=color:#66d9ef>fi</span>
<span style=color:#66d9ef>fi</span>
</code></pre></div><h2 id=enable-openvpn-server>Enable OpenVPN server</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>/etc/init.d/openvpn enable
/etc/init.d/openvpn start
</code></pre></div><p>In some cases OpenVPN won&rsquo;t start until the OpenWrt device is rebooted. I suspect the required <code>openssl</code> kernel modules are not fully enabled.</p>
<p>🎗 I should really file a bug report with the OpenWrt package maintainer.</p>
<p>You should now have a working OpenVPN remote access server deployed on OpenWrt. If, you have any questions or would like help troubleshooting issues, contact me on <a href=https://matrix.to/#/@robert:laroccx.com>Matrix</a>!</p></div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://www.laroccx.com/tags/server>server</a></li>
<li><a href=https://www.laroccx.com/tags/openvpn>openvpn</a></li>
<li><a href=https://www.laroccx.com/tags/openwrt>openwrt</a></li>
<li><a href=https://www.laroccx.com/tags/openssl>openssl</a></li>
</ul>
</footer>
</article></main>
<footer class=footer>
<span>&copy; 2021 <a href=https://www.laroccx.com/>LaRoccx</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>️</span>
<span>&#183;</span>
<span>Theme️ <a href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Paper</a></span>
</footer>
<script src=https://www.laroccx.com/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>