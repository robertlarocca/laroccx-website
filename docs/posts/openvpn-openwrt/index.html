<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Deploy an OpenVPN Server on OpenWrt 22.03 | LaRoccx</title><meta name=keywords content="server,openvpn,openwrt,openssl"><meta name=description content="ðŸ“Œ This guild also works with OpenWrt 19.07 and 21.02 releases.
This guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere."><meta name=author content="Robert LaRocca"><link rel=canonical href=https://www.laroccx.com/posts/openvpn-openwrt/><link crossorigin=anonymous href=/assets/css/stylesheet.f60300bd1212618437b2be817e250a43b03a0c55846a3b5c39869afbb7e9ed81.css integrity="sha256-9gMAvRISYYQ3sr6BfiUKQ7A6DFWEajtcOYaa+7fp7YE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://www.laroccx.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.laroccx.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.laroccx.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.laroccx.com/robert_larocca.png><link rel=mask-icon href=https://www.laroccx.com/robert_larocca.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.laroccx.com/posts/openvpn-openwrt/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="How to Deploy an OpenVPN Server on OpenWrt 22.03"><meta property="og:description" content="ðŸ“Œ This guild also works with OpenWrt 19.07 and 21.02 releases.
This guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere."><meta property="og:type" content="article"><meta property="og:url" content="https://www.laroccx.com/posts/openvpn-openwrt/"><meta property="og:image" content="https://www.laroccx.com/robert_larocca.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-20T03:15:00-04:00"><meta property="article:modified_time" content="2021-06-20T03:15:00-04:00"><meta property="og:site_name" content="LaRoccx"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.laroccx.com/robert_larocca.png"><meta name=twitter:title content="How to Deploy an OpenVPN Server on OpenWrt 22.03"><meta name=twitter:description content="ðŸ“Œ This guild also works with OpenWrt 19.07 and 21.02 releases.
This guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.laroccx.com/posts/"},{"@type":"ListItem","position":2,"name":"How to Deploy an OpenVPN Server on OpenWrt 22.03","item":"https://www.laroccx.com/posts/openvpn-openwrt/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Deploy an OpenVPN Server on OpenWrt 22.03","name":"How to Deploy an OpenVPN Server on OpenWrt 22.03","description":"ðŸ“Œ This guild also works with OpenWrt 19.07 and 21.02 releases.\nThis guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.\n","keywords":["server","openvpn","openwrt","openssl"],"articleBody":"ðŸ“Œ This guild also works with OpenWrt 19.07 and 21.02 releases.\nThis guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.\nAccess shared files, printers and other services. Protect screen sharing and remote desktop connections. Prevent eavesdropping while using public Wi-Fi networks Watch Xfinity Stream (in-home) only channels from anywhere. Expand this list ad nauseam. What is OpenVPN? OpenVPN is a full-featured open source SSL/TLS virtual private network that accommodates a wide range of configurations, including remote access, site-to-site VPNs, Wi-Fi security, and [enterprise-scale solutions] with load balancing, failover, and fine-grained access-controls. Starting with the fundamental premise that complexity is the enemy of security. OpenVPN offers a cost-effective, lightweight alternative to other VPN technologies that is well-adapted for the [home, small business, educational] and enterprise markets.\nPackages Before getting started itâ€™s a good idea to update the installed software on your OpenWrt device. Package updates generally resolve known issues, provide enhancements, and patch security vulnerabilities.\nUpgrade all installed packages These commands will not upgrade the OpenWrt operating system or Linux kernel. Only packages installed using luci or opkg are upgraded.\nopkg update opkg install $(opkg list-upgradable | awk '{ printf \"%s \",$1 }') Install OpenVPN and EasyRSA Install only the OpenVPN package build using OpenSSL. This version requires more storage then other OpenVPN packages, but offers better performance and supports more encryption algorithms.\nopkg install openvpn-openssl openvpn-easy-rsa Certificate Authority OpenVPN requires itâ€™s own Public Key Infrastructure (PKI) which consists of a Certificate Authority (CA) to sign server and client certificates. The certificates and private keys created during the next few steps are saved to /etc/easy-rsa/pki. See setting up your own Certificate Authority (CA) for more information.\nCreate a certificate authority Generate a OpenVPN certificate authority using the following commands.\neasyrsa init-pki easyrsa build-ca Create a Diffie Hellman Generate the Diffie Hellman parameter using easyrsa build-dh dh.pem. This could take a long time, depending on your OpenWrt device CPU and available entropy.\nCreate a TLS auth key The tls-auth directive adds an additional HMAC signature to all TLS handshake packets for integrity verification and provides an additional level of security above and beyond that provided by TLS alone.\nUsing the additional tls-auth server options can help protect against:\nDoS attacks or port flooding on the OpenVPN UDP port. Port scanning to determine which server UDP ports are in a listening state. Buffer overflow vulnerabilities in the TLS implementation. TLS handshake initiations from unauthorized machines are cutoff much earlier. Generate a tls-auth key using openvpn --genkey --secret ta.key.\nðŸ“¢ This key should be copied to both the server and client devices.\nCreate a server certificate Generate a server certificate using the following easyrsa command. Substitute the hostname openvpn.example.com with your fully qualified domain name (FQDN).\neasyrsa --subject-alt-name=\"DNS:openvpn.example.com\" \\ build-server-full \\ openvpn.example.com \\ nopass Create client certificates Generate a client certificate using easyrsa build-client-full user1 nopass. Substitute user1 with your real username.\nðŸ“¢ This step should be repeated for every user in your environment.\nðŸš« Never share a single client certificate amongst multiple users. Redistributing new client certificates to every user, because access was revoked from a single bad actor is a security nightmare and allot of unnecessary work.\nNow that your certificate authority, server certificate, server private key, diffie-hellman, and certificate revocation list is generated, copy them to /etc/openvpn/.\nConfigure Configure OpenVPN server Edit the OpenVPN server configuration file /etc/openvpn/server.conf. You should modify these settings to match your specific environment.\n# The OpenVPN configuration file port 1194 proto udp dev tun ca ca.crt cert openvpn.example.com.crt key openvpn.example.com.key crl-verify crl.pem dh dh.pem topology subnet server 10.8.0.0 255.255.255.0 ifconfig-pool-persist /var/openvpn/persist.leases status /var/openvpn/status.log push \"route 192.168.1.0 255.255.255.0\" push \"route 10.8.0.0 255.255.255.0\" push \"redirect-gateway def1 bypass-dhcp\" push \"dhcp-option DNS 192.168.1.1\" push \"dhcp-option DOMAIN lan\" client-to-client max-clients 254 keepalive 10 120 persist-key persist-tun cipher AES-256-GCM auth SHA384 tls-auth ta.key 0 tls-version-min 1.2 tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384 compress lz4-v2 push \"compress lz4-v2\" user nobody group nogroup verb 3 # verbosity levels range from 0-low 3-default 9-devel mute 10 # quite repeating logs after 20 messages # Only used this option in UDP mode. explicit-exit-notify 1 ðŸ‘€ The OpenVPN Community reference manual explains every setting in detail.\nCreate a network interface Add the following settings to /etc/config/network. This will create a OpenWrt network interface used to configure the firewall.\nconfig interface 'vpn' option ifname 'tun0' option proto 'none' option delegate '0' Create a firewall zone Add the following settings to /etc/config/firewall. This will create a OpenWrt firewall zone.\nconfig zone option name 'vpn' option input 'ACCEPT' option output 'ACCEPT' option forward 'ACCEPT' option masq '1' option mtu_fix '1' list network 'vpn' Configure firewall zone forwarding Add the following settings to /etc/config/firewall to configure firewall zone forwarding. This allows OpenVPN traffic to access both lan and wan zones.\nconfig forwarding option src 'lan' option dest 'vpn' config forwarding option src 'vpn' option dest 'lan' config forwarding option src 'vpn' option dest 'wan' Create an OpenVPN firewall rule Add the following settings to /etc/config/firewall to configure a firewall rule to allow inbound traffic from the Internet. Client devices will be unable to communicate with the OpenVPN server without this firewall rule enabled.\nconfig rule option name 'Allow-OpenVPN-Server' option src 'wan' option dest_port '1194' option proto 'udp' option target 'ACCEPT' Configure system startup script This was once required and may no longer be required. If, OpenWrt refuses to start automatically after a reboot. Add the following to /etc/rc.local.\nif [ -x \"/usr/sbin/openvpn\" ]; then if [ ! -d \"/tmp/openvpn\" ]; then mkdir -p /tmp/openvpn \u003e\u0026 /dev/null fi fi Enable OpenVPN server /etc/init.d/openvpn enable /etc/init.d/openvpn start In some cases OpenVPN wonâ€™t start until the OpenWrt device is rebooted. I suspect the required openssl kernel modules are not fully enabled.\nðŸŽ— I should really file a bug report with the OpenWrt package maintainer.\nYou should now have a working OpenVPN remote access server deployed on OpenWrt. If, you have any questions or would like help troubleshooting issues, contact me on Matrix!\n","wordCount":"1002","inLanguage":"en","datePublished":"2021-06-20T03:15:00-04:00","dateModified":"2021-06-20T03:15:00-04:00","author":{"@type":"Person","name":"Robert LaRocca"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.laroccx.com/posts/openvpn-openwrt/"},"publisher":{"@type":"Organization","name":"LaRoccx","logo":{"@type":"ImageObject","url":"https://www.laroccx.com/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.laroccx.com/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://www.laroccx.com/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://www.laroccx.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://www.laroccx.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.laroccx.com/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://www.laroccx.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.laroccx.com/>Home</a>&nbsp;Â»&nbsp;<a href=https://www.laroccx.com/posts/>Posts</a></div><h1 class=post-title>How to Deploy an OpenVPN Server on OpenWrt 22.03</h1><div class=post-meta>&lt;span title='2021-06-20 03:15:00 -0400 EDT'>June 20, 2021&lt;/span>&amp;nbsp;Â·&amp;nbsp;5 min&amp;nbsp;Â·&amp;nbsp;Robert LaRocca</div></header><div class=post-content><p>ðŸ“Œ This guild also works with OpenWrt <code>19.07</code> and <code>21.02</code> releases.</p><p>This guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.</p><ul><li>Access shared files, printers and other services.</li><li>Protect screen sharing and remote desktop connections.</li><li>Prevent eavesdropping while using public Wi-Fi networks</li><li>Watch Xfinity Stream (in-home) only channels from anywhere.</li><li>Expand this list ad nauseam.</li></ul><h2 id=what-is-openvpn>What is OpenVPN?<a hidden class=anchor aria-hidden=true href=#what-is-openvpn>#</a></h2><blockquote><p>OpenVPN is a full-featured open source SSL/TLS virtual private network that accommodates a wide range of configurations, including remote access, site-to-site VPNs, Wi-Fi security, and [enterprise-scale solutions] with load balancing, failover, and fine-grained access-controls. Starting with the fundamental premise that complexity is the enemy of security. OpenVPN offers a cost-effective, lightweight alternative to other VPN technologies that is well-adapted for the [home, small business, educational] and enterprise markets.</p></blockquote><h2 id=packages>Packages<a hidden class=anchor aria-hidden=true href=#packages>#</a></h2><p>Before getting started it&rsquo;s a good idea to update the installed software on your OpenWrt device. Package updates generally resolve known issues, provide enhancements, and patch security vulnerabilities.</p><h3 id=upgrade-all-installed-packages>Upgrade all installed packages<a hidden class=anchor aria-hidden=true href=#upgrade-all-installed-packages>#</a></h3><p>These commands will not upgrade the OpenWrt operating system or Linux kernel. Only packages installed using <code>luci</code> or <code>opkg</code> are upgraded.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>opkg update
</span></span><span style=display:flex><span>opkg install <span style=color:#66d9ef>$(</span>opkg list-upgradable | awk <span style=color:#e6db74>&#39;{ printf &#34;%s &#34;,$1 }&#39;</span><span style=color:#66d9ef>)</span>
</span></span></code></pre></div><h3 id=install-openvpn-and-easyrsa>Install OpenVPN and EasyRSA<a hidden class=anchor aria-hidden=true href=#install-openvpn-and-easyrsa>#</a></h3><p>Install <em>only</em> the OpenVPN package build using OpenSSL. This version requires more storage then other OpenVPN packages, but offers better performance and supports more encryption algorithms.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>opkg install openvpn-openssl openvpn-easy-rsa
</span></span></code></pre></div><h2 id=certificate-authority>Certificate Authority<a hidden class=anchor aria-hidden=true href=#certificate-authority>#</a></h2><p>OpenVPN requires it&rsquo;s own Public Key Infrastructure (PKI) which consists of a Certificate Authority (CA) to sign server and client certificates. The certificates and private keys created during the next few steps are saved to <code>/etc/easy-rsa/pki</code>. See <a href=https://openvpn.net/community-resources/setting-up-your-own-certificate-authority-ca/>setting up your own Certificate Authority (CA)</a> for more information.</p><h3 id=create-a-certificate-authority>Create a certificate authority<a hidden class=anchor aria-hidden=true href=#create-a-certificate-authority>#</a></h3><p>Generate a OpenVPN certificate authority using the following commands.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>easyrsa init-pki
</span></span><span style=display:flex><span>easyrsa build-ca
</span></span></code></pre></div><h3 id=create-a-diffie-hellman>Create a Diffie Hellman<a hidden class=anchor aria-hidden=true href=#create-a-diffie-hellman>#</a></h3><p>Generate the Diffie Hellman parameter using <code>easyrsa build-dh dh.pem</code>. This could take a long time, depending on your OpenWrt device CPU and available entropy.</p><h3 id=create-a-tls-auth-key>Create a TLS auth key<a hidden class=anchor aria-hidden=true href=#create-a-tls-auth-key>#</a></h3><blockquote><p>The tls-auth directive adds an additional HMAC signature to all TLS handshake packets for integrity verification and provides an additional level of security above and beyond that provided by TLS alone.</p></blockquote><p>Using the additional tls-auth server options can help protect against:</p><ul><li>DoS attacks or port flooding on the OpenVPN UDP port.</li><li>Port scanning to determine which server UDP ports are in a listening state.</li><li>Buffer overflow vulnerabilities in the TLS implementation.</li><li>TLS handshake initiations from unauthorized machines are cutoff much earlier.</li></ul><p>Generate a tls-auth key using <code>openvpn --genkey --secret ta.key</code>.</p><p>ðŸ“¢ This key should be copied to both the server and client devices.</p><h3 id=create-a-server-certificate>Create a server certificate<a hidden class=anchor aria-hidden=true href=#create-a-server-certificate>#</a></h3><p>Generate a server certificate using the following <code>easyrsa</code> command. Substitute the hostname <code>openvpn.example.com</code> with your fully qualified domain name (FQDN).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>easyrsa --subject-alt-name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;DNS:openvpn.example.com&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	build-server-full <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	openvpn.example.com <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	nopass
</span></span></code></pre></div><h3 id=create-client-certificates>Create client certificates<a hidden class=anchor aria-hidden=true href=#create-client-certificates>#</a></h3><p>Generate a client certificate using <code>easyrsa build-client-full user1 nopass</code>. Substitute <code>user1</code> with your real username.</p><p>ðŸ“¢ This step should be repeated for every user in your environment.</p><p>ðŸš« Never share a single client certificate amongst multiple users. Redistributing new client certificates to every user, because access was revoked from a single bad actor is a security nightmare and allot of unnecessary work.</p><p>Now that your certificate authority, server certificate, server private key, diffie-hellman, and certificate revocation list is generated, copy them to <code>/etc/openvpn/</code>.</p><h2 id=configure>Configure<a hidden class=anchor aria-hidden=true href=#configure>#</a></h2><h3 id=configure-openvpn-server>Configure OpenVPN server<a hidden class=anchor aria-hidden=true href=#configure-openvpn-server>#</a></h3><p>Edit the OpenVPN server configuration file <code>/etc/openvpn/server.conf</code>. You should modify these settings to match your specific environment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># The OpenVPN configuration file</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>port <span style=color:#ae81ff>1194</span>
</span></span><span style=display:flex><span>proto udp
</span></span><span style=display:flex><span>dev tun
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ca ca.crt
</span></span><span style=display:flex><span>cert openvpn.example.com.crt
</span></span><span style=display:flex><span>key openvpn.example.com.key
</span></span><span style=display:flex><span>crl-verify crl.pem
</span></span><span style=display:flex><span>dh dh.pem
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>topology subnet
</span></span><span style=display:flex><span>server 10.8.0.0 255.255.255.0
</span></span><span style=display:flex><span>ifconfig-pool-persist /var/openvpn/persist.leases
</span></span><span style=display:flex><span>status /var/openvpn/status.log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>push <span style=color:#e6db74>&#34;route 192.168.1.0 255.255.255.0&#34;</span>
</span></span><span style=display:flex><span>push <span style=color:#e6db74>&#34;route 10.8.0.0 255.255.255.0&#34;</span>
</span></span><span style=display:flex><span>push <span style=color:#e6db74>&#34;redirect-gateway def1 bypass-dhcp&#34;</span>
</span></span><span style=display:flex><span>push <span style=color:#e6db74>&#34;dhcp-option DNS 192.168.1.1&#34;</span>
</span></span><span style=display:flex><span>push <span style=color:#e6db74>&#34;dhcp-option DOMAIN lan&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client-to-client
</span></span><span style=display:flex><span>max-clients <span style=color:#ae81ff>254</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>keepalive <span style=color:#ae81ff>10</span> <span style=color:#ae81ff>120</span>
</span></span><span style=display:flex><span>persist-key
</span></span><span style=display:flex><span>persist-tun
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cipher AES-256-GCM
</span></span><span style=display:flex><span>auth SHA384
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tls-auth ta.key <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>tls-version-min 1.2
</span></span><span style=display:flex><span>tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>compress lz4-v2
</span></span><span style=display:flex><span>push <span style=color:#e6db74>&#34;compress lz4-v2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>user nobody
</span></span><span style=display:flex><span>group nogroup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>verb <span style=color:#ae81ff>3</span>  <span style=color:#75715e># verbosity levels range from 0-low 3-default 9-devel</span>
</span></span><span style=display:flex><span>mute <span style=color:#ae81ff>10</span> <span style=color:#75715e># quite repeating logs after 20 messages</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Only used this option in UDP mode.</span>
</span></span><span style=display:flex><span>explicit-exit-notify <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>ðŸ‘€ The OpenVPN Community <a href=https://openvpn.net/community-resources/reference-manual-for-openvpn-2-4/>reference manual</a> explains every setting in detail.</p><h3 id=create-a-network-interface>Create a network interface<a hidden class=anchor aria-hidden=true href=#create-a-network-interface>#</a></h3><p>Add the following settings to <code>/etc/config/network</code>. This will create a OpenWrt network interface used to configure the firewall.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>config interface <span style=color:#e6db74>&#39;vpn&#39;</span>
</span></span><span style=display:flex><span>	option ifname <span style=color:#e6db74>&#39;tun0&#39;</span>
</span></span><span style=display:flex><span>	option proto <span style=color:#e6db74>&#39;none&#39;</span>
</span></span><span style=display:flex><span>	option delegate <span style=color:#e6db74>&#39;0&#39;</span>
</span></span></code></pre></div><h3 id=create-a-firewall-zone>Create a firewall zone<a hidden class=anchor aria-hidden=true href=#create-a-firewall-zone>#</a></h3><p>Add the following settings to <code>/etc/config/firewall</code>. This will create a OpenWrt firewall zone.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>config zone
</span></span><span style=display:flex><span>	option name <span style=color:#e6db74>&#39;vpn&#39;</span>
</span></span><span style=display:flex><span>	option input <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
</span></span><span style=display:flex><span>	option output <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
</span></span><span style=display:flex><span>	option forward <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
</span></span><span style=display:flex><span>	option masq <span style=color:#e6db74>&#39;1&#39;</span>
</span></span><span style=display:flex><span>	option mtu_fix <span style=color:#e6db74>&#39;1&#39;</span>
</span></span><span style=display:flex><span>	list network <span style=color:#e6db74>&#39;vpn&#39;</span>
</span></span></code></pre></div><h3 id=configure-firewall-zone-forwarding>Configure firewall zone forwarding<a hidden class=anchor aria-hidden=true href=#configure-firewall-zone-forwarding>#</a></h3><p>Add the following settings to <code>/etc/config/firewall</code> to configure firewall zone forwarding. This allows OpenVPN traffic to access both <code>lan</code> and <code>wan</code> zones.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>config forwarding
</span></span><span style=display:flex><span>	option src <span style=color:#e6db74>&#39;lan&#39;</span>
</span></span><span style=display:flex><span>	option dest <span style=color:#e6db74>&#39;vpn&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>config forwarding
</span></span><span style=display:flex><span>	option src <span style=color:#e6db74>&#39;vpn&#39;</span>
</span></span><span style=display:flex><span>	option dest <span style=color:#e6db74>&#39;lan&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>config forwarding
</span></span><span style=display:flex><span>	option src <span style=color:#e6db74>&#39;vpn&#39;</span>
</span></span><span style=display:flex><span>	option dest <span style=color:#e6db74>&#39;wan&#39;</span>
</span></span></code></pre></div><h3 id=create-an-openvpn-firewall-rule>Create an OpenVPN firewall rule<a hidden class=anchor aria-hidden=true href=#create-an-openvpn-firewall-rule>#</a></h3><p>Add the following settings to <code>/etc/config/firewall</code> to configure a firewall rule to allow inbound traffic from the Internet. Client devices will be unable to communicate with the OpenVPN server without this firewall rule enabled.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>config rule
</span></span><span style=display:flex><span>	option name <span style=color:#e6db74>&#39;Allow-OpenVPN-Server&#39;</span>
</span></span><span style=display:flex><span>	option src <span style=color:#e6db74>&#39;wan&#39;</span>
</span></span><span style=display:flex><span>	option dest_port <span style=color:#e6db74>&#39;1194&#39;</span>
</span></span><span style=display:flex><span>	option proto <span style=color:#e6db74>&#39;udp&#39;</span>
</span></span><span style=display:flex><span>	option target <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
</span></span></code></pre></div><h3 id=configure-system-startup-script>Configure system startup script<a hidden class=anchor aria-hidden=true href=#configure-system-startup-script>#</a></h3><p>This was once required and may no longer be required. If, OpenWrt refuses to start automatically after a reboot. Add the following to <code>/etc/rc.local</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -x <span style=color:#e6db74>&#34;/usr/sbin/openvpn&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -d <span style=color:#e6db74>&#34;/tmp/openvpn&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>		mkdir -p /tmp/openvpn &gt;&amp; /dev/null
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div><h2 id=enable-openvpn-server>Enable OpenVPN server<a hidden class=anchor aria-hidden=true href=#enable-openvpn-server>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>/etc/init.d/openvpn enable
</span></span><span style=display:flex><span>/etc/init.d/openvpn start
</span></span></code></pre></div><p>In some cases OpenVPN won&rsquo;t start until the OpenWrt device is rebooted. I suspect the required <code>openssl</code> kernel modules are not fully enabled.</p><p>ðŸŽ— I should really file a bug report with the OpenWrt package maintainer.</p><p>You should now have a working OpenVPN remote access server deployed on OpenWrt. If, you have any questions or would like help troubleshooting issues, contact me on <a href=https://matrix.to/#/@robertlarocca:beeper.com>Matrix</a>!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.laroccx.com/tags/server/>Server</a></li><li><a href=https://www.laroccx.com/tags/openvpn/>Openvpn</a></li><li><a href=https://www.laroccx.com/tags/openwrt/>Openwrt</a></li><li><a href=https://www.laroccx.com/tags/openssl/>Openssl</a></li></ul><nav class=paginav><a class=prev href=https://www.laroccx.com/posts/bash-syntax/><span class=title>Â« Prev</span><br><span>Bash Syntax Guide</span>
</a><a class=next href=https://www.laroccx.com/posts/markdown-syntax/><span class=title>Next Â»</span><br><span>Markdown Syntax Guide</span></a></nav></footer></article></main><footer class=footer><span>Copyright &copy; <script>document.write((new Date).getFullYear())</script>Robert LaRocca.<br>This work is licensed under a <a rel=license href=/license/>Creative Commons Attribution 4.0 International License</a>.</span></footer></body></html>