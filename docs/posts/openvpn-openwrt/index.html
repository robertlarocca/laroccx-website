<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>How to Deploy an OpenVPN Server on OpenWrt 19.07 | LaRoccx</title>
<meta name=keywords content="server,openvpn,openwrt,openssl">
<meta name=description content="ðŸ“Œ This should also work on the current OpenWrt 21.02 release candidate.
This guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.">
<meta name=author content="Robert LaRocca">
<link rel=canonical href=https://www.laroccx.com/posts/openvpn-openwrt/>
<link href=/assets/css/stylesheet.min.746a86b58bb2b052b5e4df8216510494f04f81e62c08d626150c26c69ca929da.css integrity="sha256-dGqGtYuysFK15N+CFlEElPBPgeYsCNYmFQwmxpypKdo=" rel="preload stylesheet" as=style>
<link rel=icon href=https://www.laroccx.com/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://www.laroccx.com/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://www.laroccx.com/favicon-32x32.png>
<link rel=apple-touch-icon href=https://www.laroccx.com/robert_larocca.png>
<link rel=mask-icon href=https://www.laroccx.com/robert_larocca.png>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.86.1">
<meta property="og:title" content="How to Deploy an OpenVPN Server on OpenWrt 19.07">
<meta property="og:description" content="ðŸ“Œ This should also work on the current OpenWrt 21.02 release candidate.
This guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.laroccx.com/posts/openvpn-openwrt/"><meta property="og:image" content="https://www.laroccx.com/robert_larocca.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-06-20T03:15:00-04:00">
<meta property="article:modified_time" content="2021-06-20T03:15:00-04:00"><meta property="og:site_name" content="LaRoccx">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://www.laroccx.com/robert_larocca.png">
<meta name=twitter:title content="How to Deploy an OpenVPN Server on OpenWrt 19.07">
<meta name=twitter:description content="ðŸ“Œ This should also work on the current OpenWrt 21.02 release candidate.
This guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.laroccx.com/posts/"},{"@type":"ListItem","position":2,"name":"How to Deploy an OpenVPN Server on OpenWrt 19.07","item":"https://www.laroccx.com/posts/openvpn-openwrt/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Deploy an OpenVPN Server on OpenWrt 19.07","name":"How to Deploy an OpenVPN Server on OpenWrt 19.07","description":"ðŸ“Œ This should also work on the current OpenWrt 21.02 release candidate.\nThis guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.\n","keywords":["server","openvpn","openwrt","openssl"],"articleBody":"ðŸ“Œ This should also work on the current OpenWrt 21.02 release candidate.\nThis guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.\n Access shared files, printers and other services. Protect screen sharing and remote desktop connections. Prevent eavesdropping while using public Wi-Fi networks Watch Xfinity Stream (in-home) only channels from anywhere. Expand this list ad nauseam.  What is OpenVPN?  OpenVPN is a full-featured open source SSL/TLS virtual private network that accommodates a wide range of configurations, including remote access, site-to-site VPNs, Wi-Fi security, and [enterprise-scale solutions] with load balancing, failover, and fine-grained access-controls. Starting with the fundamental premise that complexity is the enemy of security. OpenVPN offers a cost-effective, lightweight alternative to other VPN technologies that is well-adapted for the [home, small business, educational] and enterprise markets.\n Packages Before getting started itâ€™s a good idea to update the installed software on your OpenWrt device. Package updates generally resolve known issues, provide enhancements, and patch security vulnerabilities.\nUpgrade all installed packages These commands will not upgrade the OpenWrt operating system or Linux kernel. Only packages installed using luci or opkg are upgraded.\nopkg update opkg install $(opkg list-upgradable | awk '{ printf \"%s \",$1 }') Install OpenVPN and EasyRSA Install only the OpenVPN package build using OpenSSL. This version requires more storage then other OpenVPN packages, but offers better performance and supports more encryption algorithms.\nopkg install openvpn-openssl openvpn-easy-rsa Certificate Authority OpenVPN requires itâ€™s own Public Key Infrastructure (PKI) which consists of a Certificate Authority (CA) to sign server and client certificates. The certificates and private keys created during the next few steps are saved to /etc/easy-rsa/pki. See setting up your own Certificate Authority (CA) for more information.\nCreate a certificate authority Generate a OpenVPN certificate authority using the following commands.\neasyrsa init-pki easyrsa build-ca Create a Diffie Hellman Generate the Diffie Hellman parameter using easyrsa build-dh dh.pem. This could take a long time, depending on your OpenWrt device CPU and available entropy.\nCreate a TLS auth key  The tls-auth directive adds an additional HMAC signature to all TLS handshake packets for integrity verification and provides an additional level of security above and beyond that provided by TLS alone.\n Using the additional tls-auth server options can help protect against:\n DoS attacks or port flooding on the OpenVPN UDP port. Port scanning to determine which server UDP ports are in a listening state. Buffer overflow vulnerabilities in the TLS implementation. TLS handshake initiations from unauthorized machines are cutoff much earlier.  Generate a tls-auth key using openvpn --genkey --secret ta.key.\nðŸ“¢ This key should be copied to both the server and client devices.\nCreate a server certificate Generate a server certificate using the following easyrsa command. Substitute the hostname openvpn.example.com with your fully qualified domain name (FQDN).\neasyrsa --subject-alt-name=\"DNS:openvpn.example.com\" \\ \tbuild-server-full \\ \topenvpn.example.com \\ \tnopass Create client certificates Generate a client certificate using easyrsa build-client-full user1 nopass. Substitute user1 with your real username.\nðŸ“¢ This step should be repeated for every user in your environment.\nðŸš« Never share a single client certificate amongst multiple users. Redistributing new client certificates to every user, because access was revoked from a single bad actor is a security nightmare and allot of unnecessary work.\nNow that your certificate authority, server certificate, server private key, diffie-hellman, and certificate revocation list is generated, copy them to /etc/openvpn/.\nConfigure Configure OpenVPN server Edit the OpenVPN server configuration file /etc/openvpn/server.conf. You should modify these settings to match your specific environment.\n# The OpenVPN configuration file port 1194 proto udp dev tun ca ca.crt cert openvpn.example.com.crt key openvpn.example.com.key crl-verify crl.pem dh dh.pem topology subnet server 10.8.0.0 255.255.255.0 ifconfig-pool-persist /var/openvpn/persist.leases status /var/openvpn/status.log push \"route 192.168.1.0 255.255.255.0\" push \"route 10.8.0.0 255.255.255.0\" push \"redirect-gateway def1 bypass-dhcp\" push \"dhcp-option DNS 192.168.1.1\" push \"dhcp-option DOMAIN lan\" client-to-client max-clients 254 keepalive 10 120 persist-key persist-tun cipher AES-256-GCM auth SHA384 tls-auth ta.key 0 tls-version-min 1.2 tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384 compress lz4-v2 push \"compress lz4-v2\" user nobody group nogroup verb 3 # verbosity levels range from 0-low 3-default 9-devel mute 10 # quite repeating logs after 20 messages # Only used this option in UDP mode. explicit-exit-notify 1 ðŸ‘€ The OpenVPN Community reference manual explains every setting in detail.\nCreate a network interface Add the following settings to /etc/config/network. This will create a OpenWrt network interface used to configure the firewall.\nconfig interface 'vpn' option ifname 'tun0' option proto 'none' option delegate '0' Create a firewall zone Add the following settings to /etc/config/firewall. This will create a OpenWrt firewall zone.\nconfig zone option name 'vpn' option input 'ACCEPT' option output 'ACCEPT' option forward 'ACCEPT' option masq '1' option mtu_fix '1' list network 'vpn' Configure firewall zone forwarding Add the following settings to /etc/config/firewall to configure firewall zone forwarding. This allows OpenVPN traffic to access both lan and wan zones.\nconfig forwarding option src 'lan' option dest 'vpn' config forwarding option src 'vpn' option dest 'lan' config forwarding option src 'vpn' option dest 'wan' Create an OpenVPN firewall rule Add the following settings to /etc/config/firewall to configure a firewall rule to allow inbound traffic from the Internet. Client devices will be unable to communicate with the OpenVPN server without this firewall rule enabled.\nconfig rule option name 'Allow-OpenVPN-Server' option src 'wan' option dest_port '1194' option proto 'udp' option target 'ACCEPT' Configure system startup script This was once required and may no longer be required. If, OpenWrt refuses to start automatically after a reboot. Add the following to /etc/rc.local.\nif [ -x \"/usr/sbin/openvpn\" ]; then if [ ! -d \"/tmp/openvpn\" ]; then mkdir -p /tmp/openvpn \u0026 /dev/null fi fi Enable OpenVPN server /etc/init.d/openvpn enable /etc/init.d/openvpn start In some cases OpenVPN wonâ€™t start until the OpenWrt device is rebooted. I suspect the required openssl kernel modules are not fully enabled.\nðŸŽ— I should really file a bug report with the OpenWrt package maintainer.\nYou should now have a working OpenVPN remote access server deployed on OpenWrt. If, you have any questions or would like help troubleshooting issues, contact me on Matrix!\n","wordCount":"1003","inLanguage":"en","datePublished":"2021-06-20T03:15:00-04:00","dateModified":"2021-06-20T03:15:00-04:00","author":{"@type":"Person","name":"Robert LaRocca"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.laroccx.com/posts/openvpn-openwrt/"},"publisher":{"@type":"Organization","name":"LaRoccx","logo":{"@type":"ImageObject","url":"https://www.laroccx.com/favicon.ico"}}}</script>
</head>
<body class=dark id=top>
<script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://www.laroccx.com/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu onscroll=menu_on_scroll()>
<li>
<a href=https://www.laroccx.com/posts/ title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://www.laroccx.com/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://www.laroccx.com/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://www.laroccx.com/archives/ title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://www.laroccx.com/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li></ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs>
<a href=https://www.laroccx.com/>Home</a>&nbsp;Â»&nbsp;<a href=https://www.laroccx.com/posts/>Posts</a>
</div>
<h1 class=post-title>
How to Deploy an OpenVPN Server on OpenWrt 19.07
</h1>
<div class=post-meta>
June 20, 2021&nbsp;Â·&nbsp;5 min&nbsp;Â·&nbsp;Robert LaRocca
</div>
</header>
<div class=post-content>
<p>ðŸ“Œ This should also work on the current <code>OpenWrt 21.02</code> release candidate.</p>
<p>This guide outlines how to configure an OpenWrt gateway as a OpenVPN server, which is perfect for providing secure remote access to your local network from anywhere.</p>
<ul>
<li>Access shared files, printers and other services.</li>
<li>Protect screen sharing and remote desktop connections.</li>
<li>Prevent eavesdropping while using public Wi-Fi networks</li>
<li>Watch Xfinity Stream (in-home) only channels from anywhere.</li>
<li>Expand this list ad nauseam.</li>
</ul>
<h2 id=what-is-openvpn>What is OpenVPN?<a hidden class=anchor aria-hidden=true href=#what-is-openvpn>#</a></h2>
<blockquote>
<p>OpenVPN is a full-featured open source SSL/TLS virtual private network that accommodates a wide range of configurations, including remote access, site-to-site VPNs, Wi-Fi security, and [enterprise-scale solutions] with load balancing, failover, and fine-grained access-controls. Starting with the fundamental premise that complexity is the enemy of security. OpenVPN offers a cost-effective, lightweight alternative to other VPN technologies that is well-adapted for the [home, small business, educational] and enterprise markets.</p>
</blockquote>
<h2 id=packages>Packages<a hidden class=anchor aria-hidden=true href=#packages>#</a></h2>
<p>Before getting started it&rsquo;s a good idea to update the installed software on your OpenWrt device. Package updates generally resolve known issues, provide enhancements, and patch security vulnerabilities.</p>
<h3 id=upgrade-all-installed-packages>Upgrade all installed packages<a hidden class=anchor aria-hidden=true href=#upgrade-all-installed-packages>#</a></h3>
<p>These commands will not upgrade the OpenWrt operating system or Linux kernel. Only packages installed using <code>luci</code> or <code>opkg</code> are upgraded.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>opkg update
opkg install <span style=color:#66d9ef>$(</span>opkg list-upgradable | awk <span style=color:#e6db74>&#39;{ printf &#34;%s &#34;,$1 }&#39;</span><span style=color:#66d9ef>)</span>
</code></pre></div><h3 id=install-openvpn-and-easyrsa>Install OpenVPN and EasyRSA<a hidden class=anchor aria-hidden=true href=#install-openvpn-and-easyrsa>#</a></h3>
<p>Install <em>only</em> the OpenVPN package build using OpenSSL. This version requires more storage then other OpenVPN packages, but offers better performance and supports more encryption algorithms.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>opkg install openvpn-openssl openvpn-easy-rsa
</code></pre></div><h2 id=certificate-authority>Certificate Authority<a hidden class=anchor aria-hidden=true href=#certificate-authority>#</a></h2>
<p>OpenVPN requires it&rsquo;s own Public Key Infrastructure (PKI) which consists of a Certificate Authority (CA) to sign server and client certificates. The certificates and private keys created during the next few steps are saved to <code>/etc/easy-rsa/pki</code>. See <a href=https://openvpn.net/community-resources/setting-up-your-own-certificate-authority-ca/>setting up your own Certificate Authority (CA)</a> for more information.</p>
<h3 id=create-a-certificate-authority>Create a certificate authority<a hidden class=anchor aria-hidden=true href=#create-a-certificate-authority>#</a></h3>
<p>Generate a OpenVPN certificate authority using the following commands.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>easyrsa init-pki
easyrsa build-ca
</code></pre></div><h3 id=create-a-diffie-hellman>Create a Diffie Hellman<a hidden class=anchor aria-hidden=true href=#create-a-diffie-hellman>#</a></h3>
<p>Generate the Diffie Hellman parameter using <code>easyrsa build-dh dh.pem</code>. This could take a long time, depending on your OpenWrt device CPU and available entropy.</p>
<h3 id=create-a-tls-auth-key>Create a TLS auth key<a hidden class=anchor aria-hidden=true href=#create-a-tls-auth-key>#</a></h3>
<blockquote>
<p>The tls-auth directive adds an additional HMAC signature to all TLS handshake packets for integrity verification and provides an additional level of security above and beyond that provided by TLS alone.</p>
</blockquote>
<p>Using the additional tls-auth server options can help protect against:</p>
<ul>
<li>DoS attacks or port flooding on the OpenVPN UDP port.</li>
<li>Port scanning to determine which server UDP ports are in a listening state.</li>
<li>Buffer overflow vulnerabilities in the TLS implementation.</li>
<li>TLS handshake initiations from unauthorized machines are cutoff much earlier.</li>
</ul>
<p>Generate a tls-auth key using <code>openvpn --genkey --secret ta.key</code>.</p>
<p>ðŸ“¢ This key should be copied to both the server and client devices.</p>
<h3 id=create-a-server-certificate>Create a server certificate<a hidden class=anchor aria-hidden=true href=#create-a-server-certificate>#</a></h3>
<p>Generate a server certificate using the following <code>easyrsa</code> command. Substitute the hostname <code>openvpn.example.com</code> with your fully qualified domain name (FQDN).</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>easyrsa --subject-alt-name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;DNS:openvpn.example.com&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	build-server-full <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	openvpn.example.com <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>	nopass
</code></pre></div><h3 id=create-client-certificates>Create client certificates<a hidden class=anchor aria-hidden=true href=#create-client-certificates>#</a></h3>
<p>Generate a client certificate using <code>easyrsa build-client-full user1 nopass</code>. Substitute <code>user1</code> with your real username.</p>
<p>ðŸ“¢ This step should be repeated for every user in your environment.</p>
<p>ðŸš« Never share a single client certificate amongst multiple users. Redistributing new client certificates to every user, because access was revoked from a single bad actor is a security nightmare and allot of unnecessary work.</p>
<p>Now that your certificate authority, server certificate, server private key, diffie-hellman, and certificate revocation list is generated, copy them to <code>/etc/openvpn/</code>.</p>
<h2 id=configure>Configure<a hidden class=anchor aria-hidden=true href=#configure>#</a></h2>
<h3 id=configure-openvpn-server>Configure OpenVPN server<a hidden class=anchor aria-hidden=true href=#configure-openvpn-server>#</a></h3>
<p>Edit the OpenVPN server configuration file <code>/etc/openvpn/server.conf</code>. You should modify these settings to match your specific environment.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># The OpenVPN configuration file</span>

port <span style=color:#ae81ff>1194</span>
proto udp
dev tun

ca ca.crt
cert openvpn.example.com.crt
key openvpn.example.com.key
crl-verify crl.pem
dh dh.pem

topology subnet
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist /var/openvpn/persist.leases
status /var/openvpn/status.log

push <span style=color:#e6db74>&#34;route 192.168.1.0 255.255.255.0&#34;</span>
push <span style=color:#e6db74>&#34;route 10.8.0.0 255.255.255.0&#34;</span>
push <span style=color:#e6db74>&#34;redirect-gateway def1 bypass-dhcp&#34;</span>
push <span style=color:#e6db74>&#34;dhcp-option DNS 192.168.1.1&#34;</span>
push <span style=color:#e6db74>&#34;dhcp-option DOMAIN lan&#34;</span>

client-to-client
max-clients <span style=color:#ae81ff>254</span>

keepalive <span style=color:#ae81ff>10</span> <span style=color:#ae81ff>120</span>
persist-key
persist-tun

cipher AES-256-GCM
auth SHA384

tls-auth ta.key <span style=color:#ae81ff>0</span>
tls-version-min 1.2
tls-cipher TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384

compress lz4-v2
push <span style=color:#e6db74>&#34;compress lz4-v2&#34;</span>

user nobody
group nogroup

verb <span style=color:#ae81ff>3</span>  <span style=color:#75715e># verbosity levels range from 0-low 3-default 9-devel</span>
mute <span style=color:#ae81ff>10</span> <span style=color:#75715e># quite repeating logs after 20 messages</span>

<span style=color:#75715e># Only used this option in UDP mode.</span>
explicit-exit-notify <span style=color:#ae81ff>1</span>
</code></pre></div><p>ðŸ‘€ The OpenVPN Community <a href=https://openvpn.net/community-resources/reference-manual-for-openvpn-2-4/>reference manual</a> explains every setting in detail.</p>
<h3 id=create-a-network-interface>Create a network interface<a hidden class=anchor aria-hidden=true href=#create-a-network-interface>#</a></h3>
<p>Add the following settings to <code>/etc/config/network</code>. This will create a OpenWrt network interface used to configure the firewall.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>config interface <span style=color:#e6db74>&#39;vpn&#39;</span>
	option ifname <span style=color:#e6db74>&#39;tun0&#39;</span>
	option proto <span style=color:#e6db74>&#39;none&#39;</span>
	option delegate <span style=color:#e6db74>&#39;0&#39;</span>
</code></pre></div><h3 id=create-a-firewall-zone>Create a firewall zone<a hidden class=anchor aria-hidden=true href=#create-a-firewall-zone>#</a></h3>
<p>Add the following settings to <code>/etc/config/firewall</code>. This will create a OpenWrt firewall zone.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>config zone
	option name <span style=color:#e6db74>&#39;vpn&#39;</span>
	option input <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
	option output <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
	option forward <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
	option masq <span style=color:#e6db74>&#39;1&#39;</span>
	option mtu_fix <span style=color:#e6db74>&#39;1&#39;</span>
	list network <span style=color:#e6db74>&#39;vpn&#39;</span>
</code></pre></div><h3 id=configure-firewall-zone-forwarding>Configure firewall zone forwarding<a hidden class=anchor aria-hidden=true href=#configure-firewall-zone-forwarding>#</a></h3>
<p>Add the following settings to <code>/etc/config/firewall</code> to configure firewall zone forwarding. This allows OpenVPN traffic to access both <code>lan</code> and <code>wan</code> zones.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>config forwarding
	option src <span style=color:#e6db74>&#39;lan&#39;</span>
	option dest <span style=color:#e6db74>&#39;vpn&#39;</span>

config forwarding
	option src <span style=color:#e6db74>&#39;vpn&#39;</span>
	option dest <span style=color:#e6db74>&#39;lan&#39;</span>

config forwarding
	option src <span style=color:#e6db74>&#39;vpn&#39;</span>
	option dest <span style=color:#e6db74>&#39;wan&#39;</span>
</code></pre></div><h3 id=create-an-openvpn-firewall-rule>Create an OpenVPN firewall rule<a hidden class=anchor aria-hidden=true href=#create-an-openvpn-firewall-rule>#</a></h3>
<p>Add the following settings to <code>/etc/config/firewall</code> to configure a firewall rule to allow inbound traffic from the Internet. Client devices will be unable to communicate with the OpenVPN server without this firewall rule enabled.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>config rule
	option name <span style=color:#e6db74>&#39;Allow-OpenVPN-Server&#39;</span>
	option src <span style=color:#e6db74>&#39;wan&#39;</span>
	option dest_port <span style=color:#e6db74>&#39;1194&#39;</span>
	option proto <span style=color:#e6db74>&#39;udp&#39;</span>
	option target <span style=color:#e6db74>&#39;ACCEPT&#39;</span>
</code></pre></div><h3 id=configure-system-startup-script>Configure system startup script<a hidden class=anchor aria-hidden=true href=#configure-system-startup-script>#</a></h3>
<p>This was once required and may no longer be required. If, OpenWrt refuses to start automatically after a reboot. Add the following to <code>/etc/rc.local</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -x <span style=color:#e6db74>&#34;/usr/sbin/openvpn&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
	<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -d <span style=color:#e6db74>&#34;/tmp/openvpn&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
		mkdir -p /tmp/openvpn &gt;&amp; /dev/null
	<span style=color:#66d9ef>fi</span>
<span style=color:#66d9ef>fi</span>
</code></pre></div><h2 id=enable-openvpn-server>Enable OpenVPN server<a hidden class=anchor aria-hidden=true href=#enable-openvpn-server>#</a></h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>/etc/init.d/openvpn enable
/etc/init.d/openvpn start
</code></pre></div><p>In some cases OpenVPN won&rsquo;t start until the OpenWrt device is rebooted. I suspect the required <code>openssl</code> kernel modules are not fully enabled.</p>
<p>ðŸŽ— I should really file a bug report with the OpenWrt package maintainer.</p>
<p>You should now have a working OpenVPN remote access server deployed on OpenWrt. If, you have any questions or would like help troubleshooting issues, contact me on <a href=https://matrix.to/#/@robert:laroccx.com>Matrix</a>!</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://www.laroccx.com/tags/server/>server</a></li>
<li><a href=https://www.laroccx.com/tags/openvpn/>openvpn</a></li>
<li><a href=https://www.laroccx.com/tags/openwrt/>openwrt</a></li>
<li><a href=https://www.laroccx.com/tags/openssl/>openssl</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://www.laroccx.com/posts/bash-syntax/>
<span class=title>Â« Prev Page</span>
<br>
<span>Bash Syntax Guide</span>
</a>
<a class=next href=https://www.laroccx.com/posts/markdown-syntax/>
<span class=title>Next Page Â»</span>
<br>
<span>Markdown Syntax Guide</span>
</a>
</nav>
</footer>
</article>
</main><footer class=footer>
<span>&copy; 2021 <a href=https://www.laroccx.com/>LaRoccx</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script defer src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>